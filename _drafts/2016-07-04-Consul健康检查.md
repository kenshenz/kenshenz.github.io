# Consul健康检查

我们已经看过如何运行Consul，添加节点和服务，也试过查找节点和服务。在这一章，我们会继续我们的旅程，为节点和服务添加健康检查。健康检查是服务发现的关键组件，它可以避免我们使用不健康的服务。

这一节建立在创建Consul集群的基础上，因此，这时你应该正运行着一个拥有两个节点的集群。

## 定义检查

类似于服务，可以通过提供检查定义或者调用HTTP API来注册检查。

我们会使用检查定义的方式，因为就像服务一样，定义是最常用的方式。

在Consul的配置目录下创建两个配置文件

```
vagrant@n2:~$ echo '{"check": {"name": "ping",
  "script": "ping -c1 google.com >/dev/null", "interval": "30s"}}' \
  >/etc/consul.d/ping.json

vagrant@n2:~$ echo '{"service": {"name": "web", "tags": ["rails"], "port": 80,
  "check": {"script": "curl localhost >/dev/null 2>&1", "interval": "10s"}}}' \
  >/etc/consul.d/web.json
```

第一个定义文件添加了主机级别的检查，叫"ping"，这个检查每个30秒执行一次，具体执行内容是`ping -c1 google.com`。在`script－base`的健康检查中，检查程序使用跟启动Consul进程相同的用户来操作。如果命令执行后的退出代码不是0，那么这节点会被标记为不健康，这是所有`scriptp-base`的健康检查所约定的。

现在，重启第二个代理或者发送一个`SIGHUP`信号，可以看到以下日志

```
==> Starting Consul agent...
...
    [INFO] agent: Synced service 'web'
    [INFO] agent: Synced check 'service:web'
    [INFO] agent: Synced check 'ping'
    [WARN] Check 'service:web' is now critical
```

前面几行日志表明代理已经同步了新的定义，最后一行日志表明我们会`web`服务添加的检查发现了问题，这是因为我们还没有运行`web`服务，因此`curl`测试失败。


## 检查健康状态

现在，我们来添加一些简单的检查，我们可以使用HTTP API。首先，我们使用以下这条命令来检查一下健康检查是否都没问题。

```
vagrant@n1:~$ curl http://localhost:8500/v1/health/state/critical
[{"Node":"agent-two","CheckID":"service:web","Name":"Service 'web' check","Status":"critical","Notes":"","ServiceID":"web","ServiceName":"web"}]
```

我们看到这里只有一个检查，关于`web`服务的，目前正处于`critical`状态。

另外，我们也可以通过DNS来查询web服务，如果服务不健康，Consul不会返回任何结果。

```
dig @127.0.0.1 -p 8600 web.service.consul
...

;; QUESTION SECTION:
;web.service.consul.        IN  A
```




























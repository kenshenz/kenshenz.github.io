# Consul集群

我们已经启动了第一个代理，并且通过它注册和发现了一个服务，这显示了Consul是如此容易使用，但没有显示出它作为一个产品级别的服务发现基础设施的扩展性、灵活性。下面，我们来创建一个拥有多个成员的集群。

当一个Consul代理启动时，它与其他节点是隔离的。如果要链接其他集群，代理必须`join`到另外一个集群。要加入另一个集群，只需要知道其中一个成员即可，当加入到这个集群后，代理会自动发现集群中其他的成员。代理可以加入任意类型的代理，不仅仅是服务模式下的代理。

## 启动代理程序

为了模拟一个更加真实的Consul集群，我们使用Vagrant（使用Docker也可以）来启动两个节点。

首先启动两个节点

```
$ vagrant up
```

启动完毕后，我们就可以通过ssh链接到节点上进行配置

```
$ vagrant ssh n1
```

在我们前面的例子中，我们使用`-dev`模式来快速搭建服务，然而这种模式并不支持集群环境。

集群中每一个节点都要有一个唯一的命名。默认地，Consul使用主机名，但我们可以通过`-node`参数来设置。

我们还会设定一个`bind`地址，Consul会监听着这个地址，注意这个地址必能可以被其他节点访问。虽然`bind`地址并不是必须的（如果不提供，Consul会默认监听系统的第一个IP地址），但最好还是提供一个。产品级别的服务一般都有很多接口，因此设置`bind`地址可以保证不会绑定Consul到错误的接口。

第一个节点会作为我们集群中的根服务，通过`service`开关来设置。

`-bootstrap-expect`标志暗示Consul服务我们还会有几个服务节点加进来。其目的是延迟启动，知道我们所期望的那n个服务节点都成功加进来了。

最后，我们增加`config-dir`标志，表示可以从哪里找到服务定义或自检定义。

以上全部整合起来的`consul agent`命令如下

```
vagrant@n1:~$ consul agent -server -bootstrap-expect 1 \
    -data-dir /tmp/consul -node=agent-one -bind=172.20.20.10 \
    -config-dir /etc/consul.d
...
```

现在，我们打开另一个终端，连接到第二个节点。

```
$ vagrant ssh n2
```

这次，我们设置`bind`地址为`agent-two`，但这节点不是一个Consul服务，所以不需要提供`server`开关。

以上全部整合起来的`consul agent`命令如下

```
vagrant@n2:~$ consul agent -data-dir /tmp/consul -node=agent-two \
    -bind=172.20.20.11 -config-dir /etc/consul.d
...
```

现在，我们已经有两个Consul代理在跑了，一个服务端和一个客户端。这两个Consul代理还不知道彼此任何的信息，可以运行`consul members`来验证这一点。

## 加入集群

现在，我们让第一个代理加入到第二个代理，通过运行以下命令

```
$ vagrant ssh n1
...
vagrant@n1:~$ consul join 172.20.20.11
Successfully joined cluster by contacting 1 nodes.
```

你应该可以看到两个代理都输出了一些日志，如果你仔细阅读，你会看到他们收到的加入的信息。如果你在两个代理各自运行`consul members`，你会看到如下信息

```
vagrant@n2:~$ consul members
Node       Address            Status  Type    Build  Protocol
agent-two  172.20.20.11:8301  alive   client  0.5.0  2
agent-one  172.20.20.10:8301  alive   server  0.5.0  2
```

> 记住：加入一个集群，Consul代理只需要知道任意一个存在的节点。加入到集群后，代理会根据gossip来获取整个成员关系信息。

## 启动时自动加入集群

理想的情况下，一个新的节点什么时候创建，都应该自动加入到Consul集群，而不是靠人为手动操作。要达到这效果，你可以使用[Atlas By HashiCorp](https://atlas.hashicorp.com/session)和`-atlas-join`标志。例子如下

```
$ consul agent -atlas-join \
  -atlas=ATLAS_USERNAME/infrastructure \
  -atlas-token="YOUR_ATLAS_TOKEN"
```

要获得Atlas的账号和token，要先创建一个账号，然后修改Consul配置文件，把账号信息替换为你注册的账号信息。现在，什么时候创建了新的节点，都会自动加入到你的Consul集群，并且没有任何硬编码，硬配置。

另外，你也可以使用`-join`标志或`start_join`配置来达到启动时自动加入集群的效果。

## 查找节点

类似查找服务，Consul提供了API（DNS API和HTTP API）来查找节点。

对于DNS API，节点名的结构是`NAME.node.consul`或`NAME.node.DATACENTER.consul`。如果不指定数据中心，则默认查找本地的数据中心。

举个例子，我们在"agent-one"下查找"agent-two"节点。

```
vagrant@n1:~$ dig @127.0.0.1 -p 8600 agent-two.node.consul
...

;; QUESTION SECTION:
;agent-two.node.consul. IN  A

;; ANSWER SECTION:
agent-two.node.consul.  0 IN    A   172.20.20.11
```

相对于查找服务，查找节点对于管理人员来说非常有用。举个例子，只要知道节点的地址，就可以轻松的查询它了。

## 离开集群

离开集群，根中断代理一样。可以使用`Ctrl-C`安全的离开，或直接杀掉代理进程。其中的区别之前已经说明过了。


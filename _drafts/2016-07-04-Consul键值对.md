# Consul键值对

除了提供服务发现、健康检查之外，Consul还提供了键值对存储功能。这可以用来动态保存配置、用于协调服务的辅助数据、推选领导节点，更多的功能留待开发人员挖掘。

这一章假设你至少运行着一个Consul代理。

## 简单使用

为了举例怎样简单使用，我们来操作一些键值对。

查询正在运行中的本地代理，我们可以先验证一下K/V存储器中没有任何东西。

```
$ curl -v http://localhost:8500/v1/kv/?recurse
* About to connect() to localhost port 8500 (#0)
*   Trying 127.0.0.1... connected
> GET /v1/kv/?recurse HTTP/1.1
> User-Agent: curl/7.22.0 (x86_64-pc-linux-gnu) libcurl/7.22.0 OpenSSL/1.0.1 zlib/1.2.3.4 libidn/1.23 librtmp/2.3
> Host: localhost:8500
> Accept: */*
>
< HTTP/1.1 404 Not Found
< X-Consul-Index: 1
< Date: Fri, 11 Apr 2014 02:10:28 GMT
< Content-Length: 0
< Content-Type: text/plain; charset=utf-8
<
* Connection #0 to host localhost left intact
* Closing connection #0
```

因为没有任何键值对，因此返回404错误。现在，我们来`PUT`一些数据。

```
$ curl -X PUT -d 'test' http://localhost:8500/v1/kv/web/key1
true
$ curl -X PUT -d 'test' http://localhost:8500/v1/kv/web/key2?flags=42
true
$ curl -X PUT -d 'test'  http://localhost:8500/v1/kv/web/sub/key3
true
$ curl http://localhost:8500/v1/kv/?recurse
[{"CreateIndex":97,"ModifyIndex":97,"Key":"web/key1","Flags":0,"Value":"dGVzdA=="},
 {"CreateIndex":98,"ModifyIndex":98,"Key":"web/key2","Flags":42,"Value":"dGVzdA=="},
 {"CreateIndex":99,"ModifyIndex":99,"Key":"web/sub/key3","Flags":0,"Value":"dGVzdA=="}]
```

我们创建了3个键，对应的值都是"test"。注意`Value`属性返回的base64编码的数据，并且允许使用非UTF-8字符。对于键"web/key2"，我们设置了`flag`为42。所有键都可以设置一个64位的整型`flag`值。Consul自身不会使用该值，但客户端可以利用这个值对键值对添加一些有意义的元数据。

设置完键值对后，我们可以发起`GET`请求带上`?recurse`参数来获取所有键值对情况。

你也可以只查询某一个键值对，例如

```
$ curl http://localhost:8500/v1/kv/web/key1
[{"CreateIndex":97,"ModifyIndex":97,"Key":"web/key1","Flags":0,"Value":"dGVzdA=="}]
```

删除键值对也很简单，使用`DELETE`来完成。我们可以提供绝对路径来删除制定键值对，也可以使用`?recurse`来删除指定目录下所有键值对。

```
$ curl -X DELETE http://localhost:8500/v1/kv/web/sub?recurse
$ curl http://localhost:8500/v1/kv/web?recurse
[{"CreateIndex":97,"ModifyIndex":97,"Key":"web/key1","Flags":0,"Value":"dGVzdA=="},
 {"CreateIndex":98,"ModifyIndex":98,"Key":"web/key2","Flags":42,"Value":"dGVzdA=="}]
```

要修改键值对，可以通过`PUT`请求来完成。另外，Consul也提供了一个CAS（Check And Set）命令来完成原子更新。只需要使用`?cas=`参数并带上最后的`ModifyIndex`	值就可以了。例如，建设我们要更新"web/key1"

```
$ curl -X PUT -d 'newval' http://localhost:8500/v1/kv/web/key1?cas=97
true
$ curl -X PUT -d 'newval' http://localhost:8500/v1/kv/web/key1?cas=97
false
```

在这个例子中，第一个CAS操作成功，因为`ModifyIndex`值为97，而第二个CAS操作失败，是因为`ModifyIndex`值已经不是97了（是不是跟乐观一样咧～）。

我门还可以利用`ModifyIndex`来等待键值对的改变，例如，假设我们想等待key2被修改

```
$ curl "http://localhost:8500/v1/kv/web/key2?index=101&wait=5s"
[{"CreateIndex":98,"ModifyIndex":101,"Key":"web/key2","Flags":42,"Value":"dGVzdA=="}]
```

提供`?index=`，表示我们要求等待直到key2的`ModifyIndex`大于101。然而`?wait=5s`参数限制了这次请求时长为5秒，超过5秒则返回当前（未被修改）的值。这功能可以用于高效地等待键值对被修改。另外，这功能也可以被用于等待一组键值对，一直等待直到任意一个键值被修改。























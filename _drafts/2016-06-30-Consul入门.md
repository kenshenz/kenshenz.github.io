# Consul入门

## 安装Consul

首先必须在Consul集群的各个节点安装Consul。为了方便用户安装，官方提供了针对各个平台的Cosul二进制包。

### 安装Consul

下载Consul安装包后，解压并放到`PATH`目录下即可使用。

### 验证安装

安装完Consul后，打开终端来验证`consul`是否有效。执行`consul`命令后你会看到一些帮助信息：

```
$ consul
usage: consul [--version] [--help] <command> [<args>]

Available commands are:
    agent          Runs a Consul agent
    configtest     Validate config file
    event          Fire a new event
    exec           Executes a command on Consul nodes
    force-leave    Forces a member of the cluster to enter the "left" state
    info           Provides debugging information for operators
    join           Tell Consul agent to join cluster
    keygen         Generates a new encryption key
    keyring        Manages gossip layer encryption keys
    leave          Gracefully leaves the Consul cluster and shuts down
    lock           Execute a command holding a lock
    maint          Controls node or service maintenance mode
    members        Lists the members of a Consul cluster
    monitor        Stream logs from a Consul agent
    reload         Triggers the agent to reload configuration files
    rtt            Estimates network round trip time between nodes
    version        Prints the Consul version
    watch          Watch for changes in Consul
```

## 运行Consul代理

安装安Consul后，必须运行Consul代理。Consul代理会在服务端和客户端运行。每个数据中心至少要有一个服务端（一般建议一个集群3到5个服务端）。

客户端是一个很轻量的程序，只用于服务注册、健康自检、服务查询。

### 运行Consul代理

为了简单，我们会启动一个开发模式的Consul代理。开发模式常用于快速搭建一个单节点的Consul环境。但在生产环境下就不建议使用，因为开发模式下不会持久化状态。

```
$ consul agent -dev
==> Starting Consul agent...
==> Starting Consul agent RPC...
==> Consul agent running!
         Node name: 'fengdeMacBook-Pro.local'
        Datacenter: 'dc1'
            Server: true (bootstrap: false)
       Client Addr: 127.0.0.1 (HTTP: 8500, HTTPS: -1, DNS: 8600, RPC: 8400)
      Cluster Addr: 192.168.1.12 (LAN: 8301, WAN: 8302)
    Gossip encrypt: false, RPC-TLS: false, TLS-Incoming: false
             Atlas: <disabled>

==> Log data will now stream in as it occurs:

    2016/06/30 22:29:44 [INFO] raft: Node at 192.168.1.12:8300 [Follower] entering Follower state
    2016/06/30 22:29:44 [INFO] serf: EventMemberJoin: fengdeMacBook-Pro.local 192.168.1.12
    2016/06/30 22:29:44 [INFO] serf: EventMemberJoin: fengdeMacBook-Pro.local.dc1 192.168.1.12
    2016/06/30 22:29:44 [INFO] consul: adding WAN server fengdeMacBook-Pro.local.dc1 (Addr: 192.168.1.12:8300) (DC: dc1)
    2016/06/30 22:29:44 [INFO] consul: adding LAN server fengdeMacBook-Pro.local (Addr: 192.168.1.12:8300) (DC: dc1)
    2016/06/30 22:29:44 [ERR] agent: failed to sync remote state: No cluster leader
    2016/06/30 22:29:45 [WARN] raft: Heartbeat timeout reached, starting election
    2016/06/30 22:29:45 [INFO] raft: Node at 192.168.1.12:8300 [Candidate] entering Candidate state
    2016/06/30 22:29:45 [DEBUG] raft: Votes needed: 1
    2016/06/30 22:29:45 [DEBUG] raft: Vote granted from 192.168.1.12:8300. Tally: 1
    2016/06/30 22:29:45 [INFO] raft: Election won. Tally: 1
    2016/06/30 22:29:45 [INFO] raft: Node at 192.168.1.12:8300 [Leader] entering Leader state
    2016/06/30 22:29:45 [INFO] raft: Disabling EnableSingleNode (bootstrap)
    2016/06/30 22:29:45 [DEBUG] raft: Node 192.168.1.12:8300 updated peer set (2): [192.168.1.12:8300]
    2016/06/30 22:29:45 [INFO] consul: cluster leadership acquired
    2016/06/30 22:29:45 [INFO] consul: New leader elected: fengdeMacBook-Pro.local
    2016/06/30 22:29:45 [DEBUG] consul: reset tombstone GC to index 2
    2016/06/30 22:29:45 [INFO] consul: member 'fengdeMacBook-Pro.local' joined, marking health alive
    2016/06/30 22:29:46 [INFO] agent: Synced service 'consul'
```

正如你所见到的，Consul代理已经启动并输出了日志。从日志上可以看到，我们的代理服务端模式下被推选为集群的领导节点。另外，本机节点也被标记为集群中健康的一员。

### 集群成员

如果你运行`consul members`，你会看到Consul集群下的所有成员。

```
$ consul members
Node                     Address            Status  Type    Build  Protocol  DC
fengdeMacBook-Pro.local  192.168.1.12:8301  alive   server  0.6.4  2         dc1
```

从输出信息可以看到节点的名称、服务地址、状态、类型等等信息，如果想看更加详细的内容，可以加上参数`-detailed`

通过`memebers`命令所看到的成员，是基于gossip协议（管理Consul节点关系和消息广播）。因此，在任意时刻，在本机代理上看到的成员关系不一定准确，如果想看到实时的准确的Consul成员信息，可以使用HTTP API来请求Consul服务端

```
$ curl http://127.0.0.1:8500/v1/catalog/nodes
[{"Node":"fengdeMacBook-Pro.local","Address":"192.168.1.12","TaggedAddresses":{"wan":"192.168.1.12"},"CreateIndex":3,"ModifyIndex":4}]
```

相比HTTP API，DNS接口可以用来查询节点，但要注意你必须确认你的DNS能搜索到Consul代理的DNS服务。

```
$ dig @127.0.0.1 -p 8600 fengdeMacBook-Pro.local
 
; <<>> DiG 9.8.3-P1 <<>> @127.0.0.1 -p 8600 fengdeMacBook-Pro.local
; (1 server found)
;; global options: +cmd
;; Got answer:
;; ->>HEADER<<- opcode: QUERY, status: SERVFAIL, id: 39339
;; flags: qr rd; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 0
;; WARNING: recursion requested but not available

;; QUESTION SECTION:
;fengdeMacBook-Pro.local.	IN	A

;; Query time: 1 msec
;; SERVER: 127.0.0.1#8600(127.0.0.1)
;; WHEN: Thu Jun 30 23:11:44 2016
;; MSG SIZE  rcvd: 41
```

### 停止Consul代理

你可以使用`Ctrl-C`来安全地终止代理程序。

在安全终止代理过程中，Consul会通知其他成员该节点要断开了。如果你强行杀掉代理进程，那么其他成员会发现该节点时一个failed状态。当一个节点断开后，它的服务和自检程序都会从catalog中移除，而当一个节点处于failed状态下，只会标识该节点的健康状态，但不会从catalog中移除。Consul会尝试连接这些failed状态的节点，如果可行则会重新连接上，否则会断开。
























